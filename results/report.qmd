---
title: "Biomarkers of ASD"
author:
- Jimmy Wu
- Jasper Luo
- Daixi Zhu
- Charles Yang
- Ben Hurt
date: last-modified
published-title: "Updated"
editor: visual
format: html
code-copy: true
execute:
  message: false
  warning: false
  echo: false
  cache: true
---

```{r, include=FALSE}
library(tidyverse)
library(here)
library(readr)
library(ggplot2)
library(dplyr)
library(knitr)
```

## Abstract

Write a brief one-paragraph abstract that describes the contents of your write-up.

## Dataset

Write a brief data description, including: how data were obtained; sample characteristics; variables measured; and data preprocessing. This can be largely based on the source paper and should not exceed 1-2 paragraphs.

```{r}
biomarker_raw <- read_csv(here::here("data", "biomarker-raw.csv"), show_col_types = FALSE)
```

## Findings

Summarize your findings here. I've included some subheaders in a way that seems natural to me; you can structure this section however you like.

### Impact of preprocessing and outliers

**Task 1**

**Task 2**

```{r, warning=FALSE}
if (!"subject_id" %in% names(biomarker_raw)) {
  biomarker_raw <- biomarker_raw %>% mutate(subject_id = row_number(), .before = 1)
}
if ("Group" %in% names(biomarker_raw) && !"group" %in% names(biomarker_raw)) {
  biomarker_raw <- biomarker_raw %>% rename(group = Group)
}

meta_cols <- c("subject_id", "group", "Target Full Name")

biomarker_raw <- biomarker_raw %>%
  mutate(across(-any_of(meta_cols), ~ readr::parse_number(as.character(.x))))

num_cols <- biomarker_raw %>%
  select(-any_of(meta_cols)) %>%
  select(where(is.numeric)) %>%
  names()
```

```{r}
outlier_limits <- biomarker_raw %>%
  select(all_of(num_cols)) %>%
  pivot_longer(everything(), names_to = "biomarker", values_to = "value") %>%
  group_by(biomarker) %>%
  summarize(
    Q1 = quantile(value, 0.25, na.rm = TRUE),
    Q3 = quantile(value, 0.75, na.rm = TRUE),
    IQR = Q3 - Q1,
    lower = Q1 - 1.5 * IQR,
    upper = Q3 + 1.5 * IQR,
    .groups = "drop"
  )

outlier_flagged <- biomarker_raw %>%
  select(subject_id, group, all_of(num_cols)) %>%
  pivot_longer(cols = all_of(num_cols), names_to = "biomarker", values_to = "value") %>%
  left_join(outlier_limits, by = "biomarker") %>%
  mutate(is_outlier = value < lower | value > upper)

subject_outlier_counts <- outlier_flagged %>%
  group_by(subject_id, group) %>%
  summarize(n_outliers = sum(is_outlier, na.rm = TRUE), .groups = "drop") %>%
  filter(!is.na(group))

summary_by_group <- subject_outlier_counts %>%
  group_by(group) %>%
  summarize(
    mean_outliers   = mean(n_outliers),
    median_outliers = median(n_outliers),
    max_outliers    = max(n_outliers),
    .groups = "drop"
  )

kable(summary_by_group, caption = "Outlier counts per subject, summarized by group")
```

```{r}
ggplot(subject_outlier_counts %>% filter(!is.na(group)),
       aes(x = group, y = n_outliers)) +
  geom_boxplot(alpha = 0.6, outlier.shape = NA) +
  geom_point(position = position_jitter(width = 0.15, height = 0), alpha = 0.6) +
  theme_minimal(base_size = 12) +
  labs(title = "Number of Outlying Biomarker Values per Subject",
       x = "Group", y = "Count of Outlying Values")
```

```{r}
subject_outlier_counts %>%
  filter(!is.na(group)) %>%
  arrange(desc(n_outliers)) %>%
  head(10) %>%
  kable(caption = "Subjects with the most outlying biomarker values")
```

### Methodological variations

Task 3

### Improved classifier

Task 4
